# Technical Requirements Document (TRD)
## ChatGPT 마이크로캡 포트폴리오 관리 시스템

### 1. 시스템 개요

#### 1.1 목적
- ChatGPT 기반 마이크로캡 포트폴리오의 자동화된 관리 및 분석
- 다중 데이터 소스를 통한 견고한 시장 데이터 접근
- 대화형 거래 입력 및 자동 손절매 시스템

#### 1.2 핵심 기능
- 실시간 포트폴리오 가치 평가
- 대화형 수동 거래 입력 (MOO/지정가)
- 자동 손절매 실행
- CAPM 기반 성과 분석
- 다중 데이터 소스 폴백 시스템

### 2. 아키텍처 요구사항

#### 2.1 데이터 소스 폴백 전략
```
1차: Yahoo Finance (yfinance) - 주 데이터 소스
2차: Stooq (pandas-datareader) - 백업 소스
3차: Stooq CSV 직접 다운로드 - 라이브러리 없을 시
4차: 프록시 인덱스 (^GSPC→SPY, ^RUT→IWM) - 최종 대안
```

#### 2.2 데이터 정규화
- 모든 소스의 OHLCV 데이터를 표준 형식으로 통일
- 필수 컬럼: [Open, High, Low, Close, Adj Close, Volume]
- DatetimeIndex 표준화

#### 2.3 날짜 처리
- 주말 거래일 매핑 (토요일→금요일, 일요일→금요일)
- 백테스트용 ASOF_DATE 오버라이드 시스템
- 반배타적 날짜 범위 [start, end) 사용

### 3. 기능 요구사항

#### 3.1 포트폴리오 관리
- **수동 거래 입력**
  - 시장가 개장 주문 (MOO)
  - 지정가 매수/매도 주문
  - 실시간 가격 검증 및 체결 시뮬레이션
- **자동 손절매**
  - 장중 최저가 기반 손절매 트리거
  - 개장가/손절가 중 최적 실행가 선택
- **포트폴리오 추적**
  - 평균단가 계산 (추가 매수 시)
  - 실시간 PnL 계산

#### 3.2 거래 로깅
- 모든 거래의 완전한 감사 추적
- 매수/매도 이유 기록
- 실행가 및 체결 소스 추적

#### 3.3 성과 분석
- **위험 지표**
  - 최대 드로다운 계산
  - 샤프 비율 (기간별/연환산)
  - 소르티노 비율 (하방 위험 조정)
- **CAPM 분석**
  - 베타 계수 vs S&P 500
  - 알파 (초과 수익률)
  - R² (설명력)

### 4. 기술 요구사항

#### 4.1 의존성
```
필수:
- pandas >= 1.0
- numpy
- yfinance
- requests

선택사항:
- pandas-datareader (Stooq 접근용)
```

#### 4.2 파일 구조
```
chatgpt_portfolio_update.csv - 포트폴리오 스냅샷
chatgpt_trade_log.csv - 거래 기록
tickers.json - 벤치마크 설정 (선택사항)
```

#### 4.3 설정 가능 요소
- 데이터 디렉토리 위치
- 벤치마크 티커 목록
- 무위험 수익률 (기본: 4.5%)

### 5. 데이터 모델

#### 5.1 포트폴리오 스키마
```
ticker: str - 종목 코드
shares: float - 보유 주식 수
buy_price: float - 평균 매수가
cost_basis: float - 총 투자 금액
stop_loss: float - 손절매가
```

#### 5.2 거래 로그 스키마
```
Date: str - 거래 날짜 (ISO)
Ticker: str - 종목 코드
Shares Bought/Sold: float - 거래량
Buy/Sell Price: float - 실행가
Cost Basis: float - 비용 기준
PnL: float - 손익
Reason: str - 거래 사유
```

#### 5.3 일일 결과 스키마
```
Date: str - 평가 날짜
Ticker: str - 종목 코드
Current Price: float - 현재가
Total Value: float - 보유 가치
PnL: float - 미실현 손익
Action: str - 보유/매도 상태
Cash Balance: float - 현금 잔고 (TOTAL 행)
Total Equity: float - 총 자본 (TOTAL 행)
```

### 6. 운영 요구사항

#### 6.1 환경 변수
- `ASOF_DATE=YYYY-MM-DD` - 백테스트용 날짜 오버라이드

#### 6.2 명령행 인터페이스
```bash
python trading_script.py 
  --file <포트폴리오_CSV_경로>
  --data-dir <데이터_디렉토리>
  --asof <YYYY-MM-DD>
```

#### 6.3 에러 처리
- 네트워크 오류 시 자동 폴백
- 빈 데이터 응답 처리
- 잘못된 사용자 입력 검증
- 거래 실패 시 롤백

### 7. 성능 요구사항

#### 7.1 응답 시간
- 단일 종목 가격 조회: < 5초
- 전체 포트폴리오 업데이트: < 30초
- 벤치마크 성과 분석: < 60초

#### 7.2 가용성
- 데이터 소스 장애 시 99% 가용성 (4단계 폴백)
- 주말/공휴일 안전한 처리

### 8. 보안 요구사항

#### 8.1 데이터 보호
- 로컬 파일 시스템만 사용 (외부 전송 없음)
- 민감한 거래 정보의 로컬 저장
- User-Agent 위장을 통한 봇 탐지 회피

#### 8.2 API 제한
- 요청 제한 준수
- 세션 재사용으로 연결 수 최소화
- 적절한 타임아웃 설정

### 9. 호환성 요구사항

#### 9.1 이전 버전과의 호환성
- 기존 CSV 형식 유지
- 동일한 파일 이름 규칙
- 동일한 출력 형식

#### 9.2 플랫폼 지원
- Windows, macOS, Linux
- Python 3.8+

### 10. 테스트 요구사항

#### 10.1 단위 테스트
- 각 데이터 소스 함수별 테스트
- 날짜 처리 함수 테스트
- 포트폴리오 계산 로직 테스트

#### 10.2 통합 테스트
- 전체 폴백 체인 테스트
- 주말 날짜 처리 테스트
- CSV 읽기/쓰기 테스트

#### 10.3 백테스트
- 과거 날짜로 ASOF_DATE 설정 테스트
- 손절매 로직 과거 데이터 검증

### 11. 모니터링 및 로깅

#### 11.1 로깅 레벨
- INFO: 거래 실행, 데이터 소스 전환
- WARNING: 데이터 소스 실패, 설정 오류
- ERROR: 시스템 수준 장애

#### 11.2 감사 추적
- 모든 거래의 완전한 기록
- 데이터 소스별 성공/실패 추적
- 성과 지표의 시계열 기록